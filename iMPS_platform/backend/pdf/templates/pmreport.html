<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>PM Report - {{ station_id }} - {{ date }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="stylesheet" href="../static/pmreport.css" /> -->
  <style>
    /* เผื่อ weasyprint หาไฟล์ css ไม่เจอ */
  </style>
</head>
<body>

<!-- Header -->
<header class="doc-header">
  <div class="logo-box">
    {% if logo %}
      <img src="{{ logo }}" alt="Logo">
    {% else %}
      <div class="logo-text">LOGO</div>
    {% endif %}
  </div>
  <div class="title-box">
    <div class="org">Address</div>
    <div class="title">Preventive Maintenance Checklist - เครื่องอัดประจุไฟฟ้า</div>
  </div>
  <div class="meta-box">
    <div class="page-hint">รหัสเอกสาร</div>
  </div>
</header>

<!-- Station Info Row -->
<section class="info">
  <table class="meta-table">
    <tr>
      <th class="w40">Location of EV Station</th>
      <td class="w60">{{ station_name }}</td>
    </tr>
    <tr>
      <th>Brand / Model</th>
      <td>{{ brand_model }}</td>
    </tr>
    <tr>
      <th>Date</th>
      <td>{{ date }}</td>
    </tr>
    <tr>
      <th>S/N</th>
      <td>{{ sn }}</td>
    </tr>
  </table>
</section>

<!-- Checklist Table -->
<section class="checklist">
  <table class="grid">
    <thead>
      <tr>
        <th class="col-item">Item</th>
        <th class="col-result" colspan="3">Result</th>
        <th class="col-remark">Remark</th>
        <th class="col-photos">Photos</th>
      </tr>
      <tr class="subhead">
        <th></th>
        <th class="tiny">pass</th>
        <th class="tiny">fail</th>
        <th class="tiny">N/A</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>

      {% set qs = [
        (1,  "1. ตรวจสอบสภาพทั่วไป",              "g1",  "r1"),
        (2,  "2. ตรวจสอบดักซีล,ซิลิโคนกันซึม",     "g2",  "r2"),
        (3,  "3. ตรวจสอบสายอัดประจุ",              "g3",  "r3"),
        (4,  "4. ตรวจสอบหัวจ่ายอัดประจุ",          "g4",  "r4"),
        (5,  "5. ตรวจสอบปุ่มหยุดฉุกเฉิน",           "g5",  "r5"),
        (6,  "6. ตรวจสอบ QR CODE",                  "g6",  "r6"),
        (7,  "7. ป้ายเตือนระวังไฟฟ้าช็อก",          "g7",  "r7"),
        (8,  "8. ป้ายเตือนต้องการระบายอากาศ",       "g8",  "r8"),
        (9,  "9. ป้ายเตือนปุ่มฉุกเฉิน",             "g9",  "r9"),
        (10, "10. วัดแรงดันวงจรควบคุมการอัดประจุ",  "g10", "r10"),
        (11, "11. ตรวจสอบแผ่นกรองระบายอากาศ",       "g11", "r11"),
        (12, "12. ตรวจสอบจุดต่อทางไฟฟ้า",            "g12", "r12"),
        (13, "13. ตรวจสอบคอนแทคเตอร์",              "g13", "r13"),
        (14, "14. ตรวจสอบอุปกรณ์ป้องกันไฟกระชาก",    "g14", "r14"),
        (15, "15. ตรวจสอบแรงดันไฟฟ้าที่พิน CP",      "g15", "r15"),
        (16, "16. ตรวจสอบลำดับเฟส",                  "g16", "r16"),
        (17, "17. วัดแรงดันไฟฟ้าด้านเข้า",            "g17", "r17"),
        (18, "18. ทดสอบการอัดประจุ",                "g18", "r18"),
        (19, "19. ทำความสะอาด",                      "g19", "r19")
      ] %}

      {% for no, label, gkey, rkey in qs %}
      <tr class="{{ 'highlight' if no in [1,19] else '' }}">
        <td class="ta-left">{{ label }}</td>

        {% set pf = (rows.get(rkey) or {}).get('pf','') %}
        <td class="ta-center">{% if pf == 'PASS' %}✓{% endif %}</td>
        <td class="ta-center">{% if pf == 'FAIL' %}✓{% endif %}</td>
        <td class="ta-center">{% if pf == 'NA'   %}✓{% endif %}</td>

        <td class="ta-left remark">
          {% if no == 15 %}
            ค่า CP: {{ cp_value }} {{ cp_unit }}
            {% set rmk = (rows.get(rkey) or {}).get('remark','') %}
            {% if rmk %}<div class="muted">{{ rmk }}</div>{% endif %}
          {% elif no == 17 %}
            <!-- ช่อง remark ของ 17 ปล่อยว่าง ใช้กริดวัดค่าแถวถัดไป -->
            {{ (rows.get(rkey) or {}).get('remark','') }}
          {% else %}
            {{ (rows.get(rkey) or {}).get('remark','') }}
          {% endif %}
        </td>

        <td class="photos">
          {% for u in (photos.get(gkey, []) | list)[:3] %}
            <img src="{{ u }}" alt="photo {{gkey}} {{ loop.index }}" class="photo">
          {% endfor %}
        </td>
      </tr>

      {% if no == 17 %}
      <tr class="measure-row">
        <td class="ta-left sublabel">
          ตารางวัดแรงดัน (หน่วย {{ m17.unit or 'V' }})
        </td>
        <td colspan="5" class="measure-cell">
          <table class="mini">
            <tr>
              <th>L1-L2</th><th>L2-L3</th><th>L3-L1</th><th>L1-N</th><th>L2-N</th><th>L3-N</th>
              <th>L1-G</th><th>L2-G</th><th>L3-G</th><th>N-G</th>
            </tr>
            <tr>
              <td>{{ m17["L1-L2"] }}</td><td>{{ m17["L2-L3"] }}</td><td>{{ m17["L3-L1"] }}</td>
              <td>{{ m17["L1-N"] }}</td> <td>{{ m17["L2-N"] }}</td> <td>{{ m17["L3-N"] }}</td>
              <td>{{ m17["L1-G"] }}</td> <td>{{ m17["L2-G"] }}</td> <td>{{ m17["L3-G"] }}</td>
              <td>{{ m17["N-G"] }}</td>
            </tr>
          </table>
        </td>
      </tr>
      {% endif %}

      {% endfor %}
    </tbody>
  </table>
</section>

<!-- Comment / Summary -->
<section class="comment">
  <div class="label">Comment :</div>
  <div class="box">{{ summary }}</div>
</section>

<!-- Signatures -->
<section class="sign">
  <table class="sign-table">
    <thead>
      <tr>
        <th class="highlight ta-center">Performed by</th>
        <th class="highlight ta-center">Approved by</th>
        <th class="highlight ta-center">Witnessed by</th>
      </tr>
    </thead>
    <tbody>
      <tr class="height-60">
        <td class="ta-center">( {{ inspector or 'ชื่อผู้ตรวจสอบ' }} )</td>
        <td class="ta-center">( )</td>
        <td class="ta-center">( )</td>
      </tr>
      <tr>
        <td class="ta-center small">Date : _____________</td>
        <td class="ta-center small">Date : _____________</td>
        <td class="ta-center small">Date : _____________</td>
      </tr>
    </tbody>
  </table>
</section>

<footer class="doc-foot">
  <span>สถานี: {{ station_id }}</span>
  <span class="right">วันที่พิมพ์: {{ (now or '') }}</span>
</footer>

</body>
</html>
